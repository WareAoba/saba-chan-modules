# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# saba-chan-modules â€” Build & Release Workflow
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ëª¨ë“ˆ ë””ë ‰í† ë¦¬ë¥¼ pushí•˜ë©´ ìžë™ìœ¼ë¡œ:
#   1. ê° ëª¨ë“ˆì˜ module.tomlì„ íŒŒì‹±í•˜ì—¬ ë²„ì „ ì¶”ì¶œ
#   2. manifest.json ìƒì„± (ì—…ë°ì´í„°ê°€ ì°¸ì¡°)
#   3. ê° ëª¨ë“ˆì„ zipìœ¼ë¡œ ì••ì¶•
#   4. GitHub Releaseë¡œ ë°°í¬
#
# ì—…ë°ì´í„°(saba-chan)ëŠ” ì´ ë¦´ë¦¬ì¦ˆì˜ manifest.jsonì„ ì½ì–´
# ë¡œì»¬ ëª¨ë“ˆ ë²„ì „ê³¼ ë¹„êµ í›„ í•„ìš”í•œ ëª¨ë“ˆë§Œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.

name: Build & Release Modules

on:
  push:
    branches: [main]
    paths:
      - '*/module.toml'
      - '*/lifecycle.py'
      - '*/i18n.py'
      - '*/locales/**'
      - '*/icon.png'
      - '**/*.ini'
      - '**/*.properties'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'ë²„ì „ ë³€ê²½ì´ ì—†ì–´ë„ ë¦´ë¦¬ì¦ˆë¥¼ ê°•ì œ ìƒì„±í•©ë‹ˆë‹¤'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ Python ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # â”€â”€ ì´ì „ ë¦´ë¦¬ì¦ˆì˜ manifest ë‹¤ìš´ë¡œë“œ (ë¹„êµìš©) â”€â”€â”€â”€â”€
      - name: Download previous manifest
        id: prev
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p .prev
          gh release download --pattern "manifest.json" --dir .prev 2>/dev/null \
            && echo "found=true" >> "$GITHUB_OUTPUT" \
            || echo "found=false" >> "$GITHUB_OUTPUT"

      # â”€â”€ ë¹Œë“œ: manifest ìƒì„± + zip ì••ì¶• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build manifest & package modules
        id: build
        run: python .github/scripts/build_modules.py
        env:
          FORCE_RELEASE: ${{ inputs.force_release || 'false' }}
          PREV_MANIFEST: ${{ steps.prev.outputs.found == 'true' && '.prev/manifest.json' || '' }}

      # â”€â”€ ê¸°ì¡´ ë¦´ë¦¬ì¦ˆ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Delete previous releases
        if: steps.build.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ—‘ï¸ Cleaning up old releases..."
          gh release list --limit 100 --json tagName -q '.[].tagName' | while read -r tag; do
            echo "  Deleting release: $tag"
            gh release delete "$tag" --yes --cleanup-tag 2>/dev/null || true
          done

      # â”€â”€ ë¦´ë¦¬ì¦ˆ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        if: steps.build.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.build.outputs.tag }}
          name: ${{ steps.build.outputs.release_name }}
          body_path: dist/RELEASE_BODY.md
          files: |
            dist/manifest.json
            dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ ê²°ê³¼ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“¦ Module Build Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.build.outputs.should_release }}" == "true" ]; then
            echo "âœ… Release created: \`${{ steps.build.outputs.tag }}\`" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Module | Version |" >> "$GITHUB_STEP_SUMMARY"
            echo "|--------|---------|" >> "$GITHUB_STEP_SUMMARY"
            cat dist/summary_table.md >> "$GITHUB_STEP_SUMMARY" 2>/dev/null || true
          else
            echo "â­ï¸ No release needed (no version changes detected)" >> "$GITHUB_STEP_SUMMARY"
          fi
